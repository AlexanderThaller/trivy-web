<!DOCTYPE html>

<html lang="en">

  <head>
    <title>Trivy Web Scanner</title>

    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width"
    >

    <link
      rel="stylesheet"
      type="text/css"
      href="/css/main.css"
    />

    <script
      async
      src="/js/htmx/2.0.0/htmx.min.js"
    ></script>
  </head>

  <body>
    <h1>Trivy Image Scanner</h1>

    <form
      id="form"
      onsubmit="updateDivs(); return false;"
    >
      <fieldset>
        <h2>Image</h2>
        <p>
          <label for="image">Image</label>
          <input
            id="image"
            name="image"
            {% if let Some(image) = image %}
            value="{{ image }}"
            {% endif %}
          />
        </p>

        <h2>Credentials</h2>
        <p>
          <label for="username">Username</label>
          <input
            id="username"
            name="username"
          />
        </p>

        <p>
          <label for="password">Password</label>
          <input
            id="password"
            type="password"
            name="password"
          />
        </p>

        <h2>Cosign</h2>
        <p>
          <label for="cosign_key">Cosign Key</label>
          <input
            id="cosign_key"
            name="cosign_key"
          />
        </p>
      </fieldset>

      <p>
        <button>Submit</button>
      </p>
    </form>

    <div id="image_information"></div>
    <div id="scan_information"></div>

    {% include "footer.html" %}

    <script>
      function slugifyHeading(text) {
        return text
          .toLowerCase()
          .trim()
          .normalize('NFKD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-z0-9\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-')
          .replace(/^-|-$/g, '');
      }

      function addHeadingAnchors(root = document) {
        var headings = root.querySelectorAll('h1, h2, h3, h4, h5, h6');
        var usedIds = new Set(
          Array.from(document.querySelectorAll('[id]')).map(function (element) {
            return element.id;
          })
        );

        headings.forEach(function (heading) {
          if (heading.dataset.anchorified === 'true') {
            return;
          }

          var baseId = heading.id || slugifyHeading(heading.textContent || '');
          if (!baseId) {
            return;
          }

          if (!heading.id) {
            var uniqueId = baseId;
            var suffix = 2;
            while (usedIds.has(uniqueId)) {
              uniqueId = baseId + '-' + suffix;
              suffix += 1;
            }
            heading.id = uniqueId;
          }

          usedIds.add(heading.id);

          var anchor = document.createElement('a');
          anchor.className = 'heading-anchor';
          anchor.href = '#' + heading.id;
          anchor.setAttribute('aria-label', 'Link to ' + heading.textContent.trim());
          anchor.textContent = '#';

          heading.append(' ', anchor);
          heading.dataset.anchorified = 'true';
        });
      }

      function updateDivs() {
        var form = document.getElementById('form');
        var formData = new FormData(form);

        var image = formData.get('image');
        var username = formData.get('username');
        var password = formData.get('password');
        var cosign_key = formData.get('cosign_key');

        let thisPage = new URL(window.location.href);
        thisPage.searchParams.set('image', image);
        window.history.pushState({}, '', thisPage);

        document.getElementById('image_information').innerHTML = `<hr><h2>Image Information</h2>
        <img src="/img/bars.svg">
        <h2>Cosign Information</h2>
        <img src="/img/bars.svg">`;

        document.getElementById('scan_information').innerHTML = `<h2>Trivy Information</h2>
        <img src="/img/bars.svg">`;
        addHeadingAnchors(document.getElementById('image_information'));
        addHeadingAnchors(document.getElementById('scan_information'));

        htmx.ajax('POST', '/image', {
          target: '#image_information',
          swap: 'innerHTML',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          values: {
            image: image,
            cosign_key: cosign_key
          }
        });

        htmx.ajax('POST', '/trivy', {
          target: '#scan_information',
          swap: 'innerHTML',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          values: {
            image: image,
            username: username,
            password: password,
          }
        });
      }

      function submitCheck() {
        if (window.location.href.includes('?')) {
          updateDivs();
        }
      }

      window.addEventListener("load", () => {
        addHeadingAnchors();
        submitCheck();
      });

      document.body.addEventListener('htmx:afterSwap', function (event) {
        addHeadingAnchors(event.target);
      });
    </script>
  </body>

</html>
